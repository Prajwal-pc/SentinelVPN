<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SentinelVPN | Threat Analytics</title>

  <!-- üé® Styles -->
  <link rel="stylesheet" href="vpn.css" />

  <!-- üìä Chart.js CDN (latest stable version) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =============================
       üéõÔ∏è DASHBOARD LAYOUT & STYLING
       ============================= */
    body {
      background-color: #0a0a0f;
      color: #fff;
      font-family: "Poppins", sans-serif;
      margin: 0;
      overflow-x: hidden;
    }

    .dash-wrap {
      max-width: 1200px;
      margin: 120px auto 60px;
      padding: 0 18px;
    }

    .dash-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .dash-title {
      color: #00f0ff;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .dash-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin: 16px 0 24px;
    }

    .kpi {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 240, 255, 0.25);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }

    .kpi .label {
      color: #a7e9ff;
      font-size: 0.85rem;
    }

    .kpi .value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-top: 6px;
      color: #fff;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 18px;
    }

    .panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 240, 255, 0.25);
      border-radius: 14px;
      padding: 16px;
    }

    .panel h3 {
      color: #00f0ff;
      margin: 0 0 10px;
      font-size: 1.1rem;
    }

    .legend {
      font-size: .9rem;
      color: #a7e9ff;
      margin-top: 8px;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online {
      background: #00ff88;
      box-shadow: 0 0 8px #00ff88;
    }

    .status-offline {
      background: #ff4444;
      box-shadow: 0 0 8px #ff4444;
    }

    .btn {
      background: linear-gradient(45deg, #00f0ff, #a020f0);
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: scale(1.03);
      filter: brightness(1.2);
    }

    .btn.secondary {
      background: linear-gradient(45deg, #333, #666);
      color: #fff;
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid #00f0ff;
      color: #a7e9ff;
    }

    /* üîî Alert Toast */
    .alert-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff0033, #ff8800);
      color: #fff;
      padding: 12px 18px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 80, 80, .8);
      z-index: 9999;
      animation: slideIn .35s ease;
    }

    .alert-popup h4 { margin: 0 0 4px; font-size: 1rem; }
    .alert-popup p { margin: 0; font-size: .9rem; }

    @keyframes slideIn {
      from { transform: translateX(200%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .fade-out { animation: fadeOut .5s forwards; }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }

    footer {
      text-align: center;
      padding: 20px;
      color: #aaa;
      margin-top: 60px;
    }
  </style>
</head>

<body>
  <!-- üß≠ NAVBAR -->
  <header class="navbar">
    <div class="logo">Sentinel<span>VPN</span></div>
    <nav>
      <ul>
        <li><a href="vpn.html">Home</a></li>
        <li><a href="#analytics">Analytics</a></li>
        <li><a href="#about">About</a></li>
      </ul>
    </nav>
  </header>

  <!-- ‚öôÔ∏è DASHBOARD -->
  <main class="dash-wrap" id="analytics">
    <div class="dash-header">
      <div>
        <div class="dash-title">Threat Analytics Dashboard</div>
        <div class="legend">
          <span id="connBadge" class="status-dot status-offline"></span>
          <span id="connText">Disconnected</span>
          <span id="ipText" style="margin-left:10px;color:#a7e9ff;"></span>
        </div>
      </div>

      <div class="dash-actions">
        <button class="btn" id="btnStart">Start VPN</button>
        <button class="btn secondary" id="btnStop">Stop VPN</button>
        <button class="btn ghost" id="btnClear">Clear Analytics</button>
        <button class="btn ghost" onclick="location.href='vpn.html'">Back</button>
      </div>
    </div>

    <!-- KPIs -->
    <section class="kpi-grid">
      <div class="kpi"><div class="label">Total Intrusions</div><div class="value" id="kpiTotalIntrusions">0</div></div>
      <div class="kpi"><div class="label">Critical / High</div><div class="value" id="kpiSevHigh">0</div></div>
      <div class="kpi"><div class="label">Avg Bandwidth</div><div class="value" id="kpiAvgBw">0 Mbps</div></div>
      <div class="kpi"><div class="label">Threats Blocked (Total)</div><div class="value" id="kpiThreatsBlocked">0</div></div>
    </section>

    <!-- Charts -->
    <section class="grid-2">
      <div class="panel"><h3>Intrusions by Severity</h3><canvas id="chartSeverity"></canvas></div>
      <div class="panel"><h3>Top Attack Types</h3><canvas id="chartTypes"></canvas></div>
    </section>

    <section class="grid-2" style="margin-top:18px">
      <div class="panel"><h3>Bandwidth Over Time</h3><canvas id="chartBandwidth"></canvas></div>
      <div class="panel"><h3>Threats Blocked Over Time</h3><canvas id="chartBlocked"></canvas></div>
    </section>
  </main>

  <!-- ‚ÑπÔ∏è ABOUT -->
  <section class="about" id="about" style="margin-top:20px">
    <h2>About Analytics</h2>
    <p>
      This dashboard aggregates live data from the SentinelVPN backend.
      Intrusions are categorized by severity and attack type.
      Metrics update automatically while connected.
    </p>
  </section>

  <!-- ü¶∂ FOOTER -->
  <footer>
    <p>¬© 2025 SentinelVPN | Analytics Module</p>
  </footer>

  <!-- ‚öôÔ∏è DASHBOARD SCRIPT -->
  <script>
    const API = "http://localhost:5000";
    const POLL_MS = 3000;

    let running = false;
    let pollTimer = null;

    const sevCounts = { Critical: 0, High: 0, Medium: 0, Low: 0 };
    const typeCounts = {};
    const bandwidthSeries = [];
    const blockedSeries = [];

    let threatsBlockedTotal = 0;
    let bandwidthSum = 0, bandwidthN = 0;

    const elConnBadge = document.getElementById("connBadge");
    const elConnText  = document.getElementById("connText");
    const elIpText    = document.getElementById("ipText");
    const elKpiTot    = document.getElementById("kpiTotalIntrusions");
    const elKpiHigh   = document.getElementById("kpiSevHigh");
    const elKpiAvgBw  = document.getElementById("kpiAvgBw");
    const elKpiBlk    = document.getElementById("kpiThreatsBlocked");

    // Toast
    function toast(title, msg) {
      const box = document.createElement("div");
      box.className = "alert-popup";
      box.innerHTML = `<h4>${title}</h4><p>${msg}</p>`;
      document.body.appendChild(box);
      setTimeout(() => box.classList.add("fade-out"), 3500);
      setTimeout(() => box.remove(), 4200);
    }

    function setOnline(ip) {
      elConnBadge.classList.replace("status-offline", "status-online");
      elConnText.textContent = "Connected";
      elIpText.textContent = ip ? "IP: " + ip : "";
    }

    function setOffline() {
      elConnBadge.classList.replace("status-online", "status-offline");
      elConnText.textContent = "Disconnected";
      elIpText.textContent = "";
    }

    // Chart variables
    let chartSev, chartTypes, chartBw, chartBlk;

    function initCharts() {
      const optBase = {
        plugins: { legend: { labels: { color: "#fff" } } },
        scales: { x: { ticks: { color: "#aafaff" } }, y: { ticks: { color: "#aafaff" }, beginAtZero: true } }
      };

      chartSev = new Chart(document.getElementById("chartSeverity"), {
        type: "pie",
        data: { labels: ["Critical","High","Medium","Low"], datasets: [{ data: [0,0,0,0], backgroundColor: ["#ff0033","#ff6600","#ffaa00","#00ffaa"] }] },
        options: { plugins: { legend: { labels: { color: "#fff" } } } }
      });

      chartTypes = new Chart(document.getElementById("chartTypes"), {
        type: "bar",
        data: { labels: [], datasets: [{ label: "Count", data: [], backgroundColor: "#00f0ff" }] },
        options: optBase
      });

      chartBw = new Chart(document.getElementById("chartBandwidth"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Bandwidth (Mbps)", data: [], borderColor: "#00f0ff", borderWidth: 2, tension: .3, pointRadius: 0 }] },
        options: optBase
      });

      chartBlk = new Chart(document.getElementById("chartBlocked"), {
        type: "line",
        data: { labels: [], datasets: [{ label: "Threats Blocked", data: [], borderColor: "#ff0033", borderWidth: 2, tension: .3, pointRadius: 0 }] },
        options: optBase
      });
    }

    function refreshCharts() {
      chartSev.data.datasets[0].data = [sevCounts.Critical, sevCounts.High, sevCounts.Medium, sevCounts.Low];
      chartSev.update();

      chartTypes.data.labels = Object.keys(typeCounts);
      chartTypes.data.datasets[0].data = Object.values(typeCounts);
      chartTypes.update();

      chartBw.data.labels = bandwidthSeries.map(p => p.t);
      chartBw.data.datasets[0].data = bandwidthSeries.map(p => p.v);
      chartBw.update();

      chartBlk.data.labels = blockedSeries.map(p => p.t);
      chartBlk.data.datasets[0].data = blockedSeries.map(p => p.v);
      chartBlk.update();
    }

    async function toggleVpn() {
      const res = await fetch(`${API}/vpn/toggle`, { method: "POST" });
      return res.json();
    }

    async function getStatus() {
      const res = await fetch(`${API}/vpn/status`);
      return res.json();
    }

    async function poll() {
      try {
        const data = await getStatus();

        if (!data.connected) {
          setOffline();
          return;
        }

        setOnline(data.ip);

        const bwVal = parseFloat((data.bandwidth || "0").replace(" Mbps", "")) || 0;
        const now = new Date().toLocaleTimeString();

        bandwidthSeries.push({ t: now, v: bwVal });
        if (bandwidthSeries.length > 30) bandwidthSeries.shift();

        blockedSeries.push({ t: now, v: data.threatsBlocked || 0 });
        if (blockedSeries.length > 30) blockedSeries.shift();

        bandwidthSum += bwVal; bandwidthN += 1;
        threatsBlockedTotal = Math.max(threatsBlockedTotal, data.threatsBlocked || 0);

        if (data.intrusion && data.intrusion.detected) {
          const sev = data.intrusion.severity || "Medium";
          const typ = data.intrusion.type || "Unknown";
          sevCounts[sev] = (sevCounts[sev] || 0) + 1;
          typeCounts[typ] = (typeCounts[typ] || 0) + 1;
          toast("‚ö†Ô∏è Intrusion Detected", `${typ} ¬∑ Severity: ${sev} ¬∑ ${data.intrusion.action || "Blocked"}`);
        }

        const totalIntrusions = Object.values(sevCounts).reduce((a, b) => a + b, 0);
        elKpiTot.textContent = totalIntrusions;
        elKpiHigh.textContent = (sevCounts.Critical || 0) + (sevCounts.High || 0);
        elKpiAvgBw.textContent = (bandwidthN ? (bandwidthSum / bandwidthN).toFixed(2) : 0) + " Mbps";
        elKpiBlk.textContent = threatsBlockedTotal;

        refreshCharts();
      } catch (e) {
        setOffline();
      }
    }

    document.getElementById("btnStart").addEventListener("click", async () => {
      const r = await toggleVpn();
      if (r.connected && !running) {
        running = true;
        setOnline(r.ip);
        if (!chartSev) initCharts();
        clearInterval(pollTimer);
        pollTimer = setInterval(poll, POLL_MS);
        poll();
      }
    });

    document.getElementById("btnStop").addEventListener("click", async () => {
      await toggleVpn();
      setOffline();
      running = false;
      clearInterval(pollTimer);
      toast("VPN Disconnected", "Monitoring stopped.");
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      Object.keys(sevCounts).forEach(k => sevCounts[k] = 0);
      Object.keys(typeCounts).forEach(k => delete typeCounts[k]);
      bandwidthSeries.length = blockedSeries.length = 0;
      bandwidthSum = bandwidthN = threatsBlockedTotal = 0;
      elKpiTot.textContent = elKpiHigh.textContent = "0";
      elKpiAvgBw.textContent = "0 Mbps";
      elKpiBlk.textContent = "0";
      if (chartSev) refreshCharts();
      toast("Cleared", "Analytics reset.");
    });

    initCharts();
    setOffline();
  </script>
</body>
</html>
